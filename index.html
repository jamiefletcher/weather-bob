<!DOCTYPE html>
<html lang="en">

<head>
    <title>weather</title>
    <meta property="og:description" content="weather-bob" />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.0.1/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@5.0.1/dist/maplibre-gl.js'></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        body { background-color: hsl(210, 20%, 95%); color: hsl(0, 0%, 20%); }
        .container { display: flex; flex-direction: column; gap: 0; margin: 0 auto; max-width: 768px; }
        .full-width { justify-content: center; align-items: center; padding: 0 20px; }
        .full-width .column { flex: 0 0 100%; margin: 0 auto; }
        .half-width { display: flex; flex-wrap: wrap; gap: 0; padding: 0 20px;}
        .half-width .column { flex: 0 0 50%; margin: 0 auto; }
        .quarter-width { display: flex; flex-wrap: wrap; gap: 0; padding: 0 20px;}
        .quarter-width .column { flex: 0 0 25%; margin: 0 auto; padding: 0 5px; }
        .third-width { display: flex; flex-wrap: wrap; gap: 0; padding: 0 20px;}
        .third-width .column { flex: 0 0 33%; margin: 0 auto; padding: 0 5px; }
        #map { background: url('img/bg1.png') no-repeat center center; background-size: contain; background-color: hsl(0, 0%, 100%); height: 190px; width: 190px; margin: 10px auto 0px auto; overflow: visible; border-radius: 50%; }
        .maplibregl-ctrl-bottom-right { display: none; } 
        .maplibregl-canvas { pointer-events: none; }
        @media (max-width: 768px) {
            .half-width .column { flex: 0 0 100%; }
        }
        .bob{ width:75px; }
        hr {border:none; height:5px; background-color: hsl( 0, 0%, 20%); margin: 5px 0 5px 0; }
        .hr-thin {border:none; height:2px; background-color: hsl( 0, 0%, 20%); margin: 5px 0 5px 0; }
        h1 { font-family: 'Roboto Mono'; font-size: 60px; font-weight: 600; letter-spacing: -2px; line-height: 0.8; }
        h2 { font-family: 'Roboto Mono'; font-size: 26px; font-weight: 500; letter-spacing: -2px; line-height: 1; }
        h3 { font-family: 'Roboto Mono'; font-size: 13px; font-weight: 400; letter-spacing: 0px; line-height: 1; margin: 3px 0 0 0; text-transform: uppercase; }
        h4 { font-family: 'Roboto Mono'; color: hsl(0, 0%, 50%); font-size: 8px; font-weight: 600; letter-spacing: 1px; line-height: 1; margin: 3px 0 0 0; }
        p { font-size: 13px; font-weight: 400; letter-spacing: 0; }
        span { font-family: 'Roboto Mono'; font-size: 11px; letter-spacing: 0; margin: 0 0 0 3px; }
        @import url('https://fonts.googleapis.com/css2?family=Montserrat&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');
</style>
</head>

<body>

    <div class="container">
        <div class="full-width" id="station"></div>

        <div class="third-width" id="weather"></div> 

        <div class="full-width">
            <div class="column"><div id="map"></div></div>
        </div> 

        <div class="full-width">
            <img class="bob" src="img/bob.png">
            <div id="weather_description"></div>
        </div>
    </div>

    <script>

        const map = new maplibregl.Map({
            container: 'map',
            style: 'weather-bob.json',
            center: [137.9150899566626, 36.25956997955441],
            zoom: 0,
            minzoom: 0,
            antialias: true
        });

        function getAdjustedZoom(latitude, baseZoom = 0) {
            return baseZoom + Math.log2(Math.cos(latitude * Math.PI / 180));
        }
        
        async function fetchAndMove() {
            try {
                // fetch JSON file
                const response = await fetch('https://raw.githubusercontent.com/jamiefletcher/weather-bob/refs/heads/main/data/metars/current-weather.json');
                const data = await response.json();

                // extract data
                const station = {};
                let index = 0;
                let interval = 3000;

                Object.keys(data).forEach((key, index) => {
                    Object.entries(data[key]).forEach(([prop, value]) => {
                        if (prop === "geometry" && value.coordinates) {
                            // Store coordinates in the station object by index
                            (station["coordinates"] ||= [])[index] = value.coordinates;
                        } else {
                            // Store other properties like temperature, station_name, etc. by index
                            (station[prop] ||= [])[index] = value;
                        }
                    });
                });

                function panToStation() {
                    const coordinates = station["coordinates"][index]
                    const latitude = coordinates[1];
                    const adjustedZoom = getAdjustedZoom(latitude, 0);
                    
                    map.panTo(coordinates, {
                        duration: 1000,
                        easing: (t) => t,
                        animate: true,
                        offset: [0, 0],
                        bearing: 0,
                        zoom: adjustedZoom
                    });
                    
                    document.getElementById('station').innerHTML = `
                        <hr>
                        <div class="column"><h4>STATION</h4><h1>${station["id"][index]}</h1></div>
                        <div class="column"><h4>SITE</h4><h3>${station["site"][index]}</h3></div>
                        <hr class="hr-thin">                        
                    `;
                    document.getElementById('weather').innerHTML = `
                        <div class="column" style="border-right:1px solid hsl(0, 0%, 70%)"><h4>TEMP</h4><h2>${parseInt(station["temp"][index])}<span>Â°C</span></h2></div>
                        <div class="column" style="border-right:1px solid hsl(0, 0%, 70%)"><h4>WIND</h4><h2>${parseInt(station["wspd_kmph"][index])}<span>km/h</span></h2></div>
                        <div class="column"><h4>HUMIDITY</h4><h2>${parseInt(station["rh"][index])}<span>%</span></h2></div>
                    `;
                    document.getElementById('weather_description').innerHTML = `
                        <div class="column"><p>${station["weather_description"][index]}</p></div>
                    `;

                    map.on('moveend', () => {
                        index = (index + 1) % station["coordinates"].length;
                    });
                }
                panToStation();

                setInterval(panToStation, interval);

            } catch (error) {
                console.error('Error fetching JSON:', error);
            }
        };
        fetchAndMove();

</script>
</body>

</html>